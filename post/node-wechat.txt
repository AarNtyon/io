1:HL["/_next/static/css/0ff8ba3f2ba3a44a.css",{"as":"style"}]
0:[[["",{"children":["post",{"children":[["slug","node-wechat","d"],{"children":["__PAGE__?{\"slug\":\"node-wechat\"}",{}]}]}]},"$undefined","$undefined",true],"$L2",[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/0ff8ba3f2ba3a44a.css","precedence":"next"}]],["$L3",null]]]]
4:HL["/_next/static/css/5046688ea5e44c5b.css",{"as":"style"}]
5:I{"id":"8920","chunks":["920:static/chunks/920-2fb459665447a51a.js","605:static/chunks/app/post/[slug]/page-7850bc001eeba8e4.js"],"name":"","async":false}
6:"$Sreact.suspense"
7:I{"id":"7069","chunks":["920:static/chunks/920-2fb459665447a51a.js","185:static/chunks/app/layout-9b9665c86b0d6757.js"],"name":"NoSSR","async":false}
8:I{"id":"5554","chunks":["920:static/chunks/920-2fb459665447a51a.js","185:static/chunks/app/layout-9b9665c86b0d6757.js"],"name":"","async":false}
9:I{"id":"4463","chunks":["272:static/chunks/webpack-8f5cefd325c1e5c1.js","667:static/chunks/2443530c-824e93370d7398c3.js","488:static/chunks/488-e1ddd61bb847c097.js"],"name":"","async":false}
a:I{"id":"1010","chunks":["272:static/chunks/webpack-8f5cefd325c1e5c1.js","667:static/chunks/2443530c-824e93370d7398c3.js","488:static/chunks/488-e1ddd61bb847c097.js"],"name":"","async":false}
c:I{"id":"2263","chunks":["920:static/chunks/920-2fb459665447a51a.js","185:static/chunks/app/layout-9b9665c86b0d6757.js"],"name":"","async":false}
2:[["$","html",null,{"lang":"en","children":[["$","link",null,{"rel":"rainc.io","href":"/favicon.ico"}],["$","body",null,{"children":["$","div",null,{"id":"__next","children":["$","div",null,{"id":"app","className":"flex h-100% flex-col","children":[["$","header",null,{"className":"flex justify-between w-68% h-66px m-auto items-center xs:w-100% p-l-80px p-r-80px xs:p-l-30px xs:p-r-30px shrink-0","children":[["$","$L5",null,{"className":"text-20px cursor-pointer font-bold font-mono dark:color-white ","href":"/","children":["$","span",null,{"children":"Rain's Blog"}]}],["$","nav",null,{"className":"flex items-center column-50px","children":[["$","nav",null,{"className":"text-right opacity-[0.6] text-[16px] dark:color-#e5e7eb flex","children":[["$","$L5",null,{"className":"mr-20px","href":"/post","children":[["$","span",null,{"className":"xs:hidden md:block","children":"博客"}],["$","i",null,{"className":"xs:block  md:hidden dark:color-#fff i-carbon-align-box-top-left"}]]}],["$","$L5",null,{"className":"mr-20px","href":"/moment","children":[["$","span",null,{"className":"xs:hidden md:block","children":"随笔"}],["$","i",null,{"className":"xs:block  md:hidden dark:color-#fff i-carbon-bookmark-add"}]]}],["$","$L5",null,{"className":"mr-20px","href":"/about","children":[["$","span",null,{"className":"xs:hidden md:block","children":"关于"}],["$","i",null,{"className":"xs:block  md:hidden dark:color-#fff i-carbon-sprout"}]]}]]}],["$","$6",null,{"fallback":null,"children":["$","$L7",null,{"children":["$","$L8",null,{}]}]}]]}]]}],["$","main",null,{"className":"font-sans flex-auto","children":["$","$L9",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$La",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$","$L9",null,{"parallelRouterKey":"children","segmentPath":["children","post","children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$La",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$","$L9",null,{"parallelRouterKey":"children","segmentPath":["children","post","children",["slug","node-wechat","d"],"children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$La",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$Lb",null],"segment":"__PAGE__?{\"slug\":\"node-wechat\"}"},"styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/5046688ea5e44c5b.css","precedence":"next"}]]}],"segment":["slug","node-wechat","d"]},"styles":[]}],"segment":"post"},"styles":[]}]}],["$","footer",null,{"className":"dark:color-white text-center h-66px leading-[66px]","children":["© ",2023,", Rain | Powered by Next.js"]}],["$","$6",null,{"fallback":null,"children":["$","$L7",null,{"children":["$","$Lc",null,{}]}]}]]}]}]}]]}],null]
3:[[["$","meta",null,{"charSet":"utf-8"}],["$","title",null,{"children":"微信公众号开发入门"}],["$","meta",null,{"name":"description","content":"learn more thing"}],null,null,null,null,null,null,null,null,["$","meta",null,{"name":"viewport","content":"width=device-width, initial-scale=1"}],null,null,null,null,null,null,null,null,null,null,[]],[null,null,null,null],null,null,[null,null,null,null,null],null,null,null,null,[null,[["$","link",null,{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"any"}]],[],null]]
b:"$Ld"
d:["$","div",null,{"className":"prose w-60% m-auto m-b-50px xs:w-90% m-t-66px","children":[["$","div",null,{"className":"m-b-30px","children":["$","div",null,{"children":[["$","h1",null,{"children":"微信公众号开发入门"}],["$","p",null,{"className":"flex justify-between","children":[["$","span",null,{"className":"color-gray","children":["Rain, ","Mon  Jul  10  2023"]}],["$","$L5",null,{"className":"cursor-pointer color-gray","href":"/post","children":"back"}]]}]]}]}],["$","article",null,{"className":"prose","dangerouslySetInnerHTML":{"__html":"<h2>前言</h2>\n<p>如果当前的你并没有微信公众号，又想尝试有关微信网页技术，那也是可以的，因为微信提供了测试号，无需公众帐号，直接体验和测试公众平台所有高级接口，点击访问<a href=\"https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login\">测试平台</a></p>\n<p>访问上面的网址完成扫码授权后，我们会拿到一些测试号信息，分别是<strong>appID</strong>和<strong>appsecret</strong>，如下图</p>\n<p><img src=\"https://image.rainc.io/node-wechat/Snipaste_2023-07-10_09-14-17.png\" alt=\"info\"></p>\n<h4>接下来就来到了开发中最关键的一步，如果这一步过不了接下来的工作都没法完成，官网是这样描述的。</h4>\n<blockquote>\n<p>请填写接口配置信息，此信息需要你有自己的服务器资源，填写的URL需要正确响应微信发送的Token验证</p>\n</blockquote>\n<p>意思是说我们需要把代码上传到线上服务器才能响应微信的验证，但这样对我们来说并不友好。原因之一就是不能在 ide 实时地进行代码调试。办法总比困难多，只要配置下内网穿透就能轻易解决。在这里推荐使用的是 <strong>ngrok</strong> 。官网有教程且操作十分简单，这里便不过多赘述。相关网址：<strong>https://www.ngrok.cc</strong></p>\n<p>查看<a href=\"https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Access_Overview.html\">微信消息接口使用指南</a>得知发送验证请求之前需要填写服务器配置，如下图</p>\n<p><img src=\"https://image.rainc.io/node-wechat/Snipaste_2023-07-10_09-17-12.png\" alt=\"config\"></p>\n<p>第一个输入框需要填写的是我们本地做验证微信服务器的接口地址，假设本地的接口地址是 <strong>/configVerification</strong>，开启本地服务，拿到内网地址以及端口号，通过<strong>ngrok</strong>映射过后的外网地址假设是 <strong>http:answer-ngrok.com</strong>,那么拼接起来即是：<strong>http:answer-ngrok.com/configVerification</strong>，而 <strong>token</strong> 则是自定义用来校验的。</p>\n<h3>代码层面，依次编写wxconfig，controller，service</h3>\n<p>新建 <code>wxConfig</code> 文件，将微信提供的信息以及自己定义的字段保存到这个文件</p>\n<pre class=\"pre-dark\"><code><span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">wxConfig</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #E06C75\">wxRequestPath</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #98C379\">&#39;https://api.weixin.qq.com&#39;</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #E06C75\">wxAccount</span><span style=\"color: #ABB2BF\">:</span><span style=\"color: #98C379\">&#39;your account&#39;</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #E06C75\">wechatOpt</span><span style=\"color: #ABB2BF\">: {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #E06C75\">appID</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #98C379\">&#39;your appid&#39;</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #E06C75\">appsecret</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #98C379\">&#39;your appsecret&#39;</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #E06C75\">token</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #98C379\">&#39;your token&#39;</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #E06C75\">scoped</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #98C379\">&#39;snsapi_userinfo&#39;</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #7F848E; font-style: italic\">// 授权成功重定向地址，可以是前端地址也可以是后端接口地址</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #7F848E; font-style: italic\">// 如果重定向到后端接口地址，后端可以在当前service中做操作，比如使之回到前端的页面或第三方页面</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #E06C75\">redirect_url</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #98C379\">`your rediretUrl`</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  },</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"><span style=\"color: #C678DD\">export</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">default</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E06C75\">wxConfig</span></span>\n<span class=\"line\"></span></code></pre>\n<p>新建 <code>controller</code> 配置官网填写的用来验证接口地址，调用service</p>\n<pre class=\"pre-dark\"><code><span class=\"line\"><span style=\"color: #7F848E; font-style: italic\">// controller</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">@</span><span style=\"color: #61AFEF\">Get</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">&#39;/configVerification&#39;</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">@</span><span style=\"color: #61AFEF\">ApiOperation</span><span style=\"color: #ABB2BF\">({ </span><span style=\"color: #E06C75\">summary</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #98C379\">&#39;微信接口配置信息校验&#39;</span><span style=\"color: #ABB2BF\"> })</span></span>\n<span class=\"line\"><span style=\"color: #61AFEF\">wxConfigVerification</span><span style=\"color: #ABB2BF\">(@</span><span style=\"color: #61AFEF\">Query</span><span style=\"color: #ABB2BF\">() </span><span style=\"color: #E06C75\">params</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #E06C75\">IwxVerification</span><span style=\"color: #ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">return</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">this</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E5C07B\">wxService</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">wxVerificationService</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">params</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>新建 <code>service</code> 根据官网示例代码进行编写</p>\n<pre class=\"pre-dark\"><code><span class=\"line\"><span style=\"color: #7F848E; font-style: italic\">// service</span></span>\n<span class=\"line\"><span style=\"color: #E06C75\">async</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">wxVerificationService</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">params</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #E06C75\">IwxVerification</span><span style=\"color: #ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">try</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E5C07B\">nonce</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E5C07B\">signature</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E5C07B\">timestamp</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E5C07B\">echostr</span><span style=\"color: #ABB2BF\"> } </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E06C75\">params</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E5C07B\">token</span><span style=\"color: #ABB2BF\"> } </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">wxConfig</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">wechatOpt</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">str</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> [</span><span style=\"color: #E06C75\">token</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">timestamp</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">nonce</span><span style=\"color: #ABB2BF\">].</span><span style=\"color: #61AFEF\">sort</span><span style=\"color: #ABB2BF\">().</span><span style=\"color: #61AFEF\">join</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">&#39;&#39;</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">sha1Str</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">sha1</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">str</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #C678DD\">if</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">sha1Str</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">===</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E06C75\">signature</span><span style=\"color: #ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">      </span><span style=\"color: #C678DD\">return</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E06C75\">echostr</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    } </span><span style=\"color: #C678DD\">else</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">      </span><span style=\"color: #C678DD\">throw</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">new</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">errResult</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #D19A66\">201</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #98C379\">&#39;校验失败&#39;</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    }</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  } </span><span style=\"color: #C678DD\">catch</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">error</span><span style=\"color: #ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #C678DD\">throw</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">new</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">errResult</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #D19A66\">500</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">error</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  }</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p><img src=\"https://image.rainc.io/node-wechat/Snipaste_2023-07-10_16-53-17.png\" alt=\"website\"></p>\n<p>编写完成后进入测试环节，运行服务，回到微信官网，点击保存按钮，随后微信就会向你填写的地址发送一个请求，如果<strong>ngrok</strong> 用来映射的地址与你本地服务地址一致，那么此时不管验证成功或失败，你都可以拿到微信返回的校验参数，最后就是通过<code>sha1</code>加密库进行加密匹配。如果匹配成功网页就会弹窗成功，反之失败。</p>\n<blockquote>\n<p>需要注意的是匹配成功是直接返回echostr信息，一般我们都是在框架中测试这一部分，有些框架会自带拦截器或是我们自己封装，把数据包装一遍再抛出去，所以我们要对这一步做白名单</p>\n</blockquote>\n<h2>获取微信用户的基本信息</h2>\n<ul>\n<li>\n<p>第一步，填写js接口安全域名</p>\n<p><img src=\"https://image.rainc.io/node-wechat/Snipaste_2023-07-10_09-17-38.png\" alt=\"website\"></p>\n<p>需要注意的点是这里它要的是一个域名而不是一个网址。所以不用带<code>http</code>前缀，也不用带地址后缀，把被 <strong>ngrok</strong> 映射过的域名填入即可</p>\n</li>\n<li>\n<p>第二步，找到网页账号的功能，网页授权获取用户基本信息，</p>\n<p>点击右侧修改，出现弹窗</p>\n<p><img src=\"https://image.rainc.io/node-wechat/Snipaste_2023-07-12_11-50-44.png\" alt=\"redirect\"></p>\n<p>这里需要的也是一个域名，起初我以为是一个重定向地址，其实不是，反正跟第一步填一样就行。</p>\n</li>\n</ul>\n<h3>配置完成，开始编写代码层面</h3>\n<p>这里先理清下思绪，大致分为三步</p>\n<blockquote>\n<p>第一步：用户同意授权，获取code</p>\n</blockquote>\n<blockquote>\n<p>第二步：通过code换取网页授权access_token</p>\n</blockquote>\n<blockquote>\n<p>第三步：拉取用户信息(需scope为 snsapi_userinfo)</p>\n</blockquote>\n<ul>\n<li>\n<p>跳转微信公众号授权网页</p>\n<p>这一步可以在前端做或是在后端做，这里是交给后端。</p>\n<pre class=\"pre-dark\"><code><span class=\"line\"><span style=\"color: #7F848E; font-style: italic\">// controller</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">@</span><span style=\"color: #61AFEF\">Get</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">&#39;/redirect&#39;</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">@</span><span style=\"color: #61AFEF\">ApiOperation</span><span style=\"color: #ABB2BF\">({ </span><span style=\"color: #E06C75\">summary</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #98C379\">&#39;微信授权定向跳转&#39;</span><span style=\"color: #ABB2BF\"> })</span></span>\n<span class=\"line\"><span style=\"color: #61AFEF\">wxRedirect</span><span style=\"color: #ABB2BF\">() {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #C678DD\">return</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">this</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E5C07B\">wxService</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">wxAuthorizePathService</span><span style=\"color: #ABB2BF\">()</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>可以看到 return 了一个微信地址，这个地址直接在官网文档复制然后把对应的参数配置成自己的，对应 <code>wxConfig</code>文件，着重是 <code>redirect_url</code>，这个是授权成功后的重定向地址，同可以设置成前端的地址还是后端的，在前面已经说过了。</p>\n<pre class=\"pre-dark\"><code><span class=\"line\"><span style=\"color: #7F848E; font-style: italic\">//service</span></span>\n<span class=\"line\"><span style=\"color: #E06C75\">async</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">wxAuthorizePathService</span><span style=\"color: #ABB2BF\">() {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">return</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #98C379\">`https://open.weixin.qq.com/connect/oauth2/authorize?appid=</span><span style=\"color: #C678DD\">${</span><span style=\"color: #E5C07B\">wxConfig</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E5C07B\">wechatOpt</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">appID</span><span style=\"color: #C678DD\">}</span><span style=\"color: #98C379\">&amp;redirect_uri=</span><span style=\"color: #C678DD\">${</span><span style=\"color: #E5C07B\">wxConfig</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E5C07B\">wechatOpt</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">redirect_url</span><span style=\"color: #C678DD\">}</span><span style=\"color: #98C379\">&amp;response_type=code&amp;scope=</span><span style=\"color: #C678DD\">${</span><span style=\"color: #E5C07B\">wxConfig</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E5C07B\">wechatOpt</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">scoped</span><span style=\"color: #C678DD\">}</span><span style=\"color: #98C379\">&amp;state=STATE#wechat_redirect`</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>一切就绪，当前端发起请求后就会拿到这个地址进行跳转就会进入微信公众号授权页面，当用户同意授权之后，前面配置的 <code>redirect_url</code> 就会生效，从而在当前浏览器中跳转到这个<code>redirect_url</code>地址,前面说了这个可以是前端的页面地址也可以是后端的接口地址，而微信就会在这个地址后面拼接上一个<code>code</code>参数。有了这个<code>code</code>就可以拿到<code>token</code>，有了<code>token</code>就可以请求微信的接口拿到用户的基本信息。</p>\n</li>\n<li>\n<p>授权完成获取用户基本信息</p>\n<p>定义一个获取用户信息的路由</p>\n<pre class=\"pre-dark\"><code><span class=\"line\"><span style=\"color: #7F848E; font-style: italic\">// controller</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">@</span><span style=\"color: #61AFEF\">Get</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">&#39;/userinfo&#39;</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">@</span><span style=\"color: #61AFEF\">ApiOperation</span><span style=\"color: #ABB2BF\">({ </span><span style=\"color: #E06C75\">summary</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #98C379\">&#39;获取授权后的用户信息&#39;</span><span style=\"color: #ABB2BF\"> })</span></span>\n<span class=\"line\"><span style=\"color: #61AFEF\">wxGetAuthUserInfo</span><span style=\"color: #ABB2BF\">(@</span><span style=\"color: #61AFEF\">Query</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">&#39;code&#39;</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #E06C75\">code</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #E06C75\">string</span><span style=\"color: #ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">return</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">this</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E5C07B\">wxService</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">wxGetAuthorizationUserInfo</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">code</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n</li>\n</ul>\n<p>前面说过获取用户信息需要通过code换取token，有了token之后才能拉取用户信息，而这两步操作是需要请求微信服务器的，所以这里使用axios进行网络请求。</p>\n<pre class=\"pre-dark\"><code><span class=\"line\"><span style=\"color: #7F848E; font-style: italic\">// 获取access_token</span></span>\n<span class=\"line\"><span style=\"color: #C678DD\">export</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">getAccessTokenApi</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75; font-style: italic\">code</span><span style=\"color: #ABB2BF\">:</span><span style=\"color: #E5C07B\">number</span><span style=\"color: #ABB2BF\"> | </span><span style=\"color: #E5C07B\">string</span><span style=\"color: #ABB2BF\">):</span><span style=\"color: #E5C07B\">Promise</span><span style=\"color: #ABB2BF\">&lt;</span><span style=\"color: #E5C07B\">IwxAccessToken</span><span style=\"color: #ABB2BF\"> | </span><span style=\"color: #E5C07B\">any</span><span style=\"color: #ABB2BF\">&gt; </span><span style=\"color: #C678DD\">=&gt;</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">return</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">request</span><span style=\"color: #ABB2BF\">({</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #E06C75\">url</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #98C379\">`</span><span style=\"color: #C678DD\">${</span><span style=\"color: #E5C07B\">wxConfig</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">wxRequestPath</span><span style=\"color: #C678DD\">}</span><span style=\"color: #98C379\">/sns/oauth2/access_token?appid=</span><span style=\"color: #C678DD\">${</span><span style=\"color: #E5C07B\">wxConfig</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E5C07B\">wechatOpt</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">appID</span><span style=\"color: #C678DD\">}</span><span style=\"color: #98C379\">&amp;secret=</span><span style=\"color: #C678DD\">${</span><span style=\"color: #E5C07B\">wxConfig</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E5C07B\">wechatOpt</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">appsecret</span><span style=\"color: #C678DD\">}</span><span style=\"color: #98C379\">&amp;code=</span><span style=\"color: #C678DD\">${</span><span style=\"color: #E06C75\">code</span><span style=\"color: #C678DD\">}</span><span style=\"color: #98C379\">&amp;grant_type=authorization_code`</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #E06C75\">method</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #98C379\">&#39;get&#39;</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  })</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"><span style=\"color: #7F848E; font-style: italic\">// 获取用户信息</span></span>\n<span class=\"line\"><span style=\"color: #7F848E; font-style: italic\">// params参数均是获取token后微信返回的</span></span>\n<span class=\"line\"><span style=\"color: #C678DD\">export</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">getUserInfoApi</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75; font-style: italic\">params</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #E5C07B\">IwxUserInfo</span><span style=\"color: #ABB2BF\">): </span><span style=\"color: #E5C07B\">Promise</span><span style=\"color: #ABB2BF\">&lt;</span><span style=\"color: #E5C07B\">IwxGotItUserInfo</span><span style=\"color: #ABB2BF\"> | </span><span style=\"color: #E5C07B\">any</span><span style=\"color: #ABB2BF\">&gt; </span><span style=\"color: #C678DD\">=&gt;</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">return</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">request</span><span style=\"color: #ABB2BF\">({</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #E06C75\">url</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #98C379\">`</span><span style=\"color: #C678DD\">${</span><span style=\"color: #E5C07B\">wxConfig</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">wxRequestPath</span><span style=\"color: #C678DD\">}</span><span style=\"color: #98C379\">/sns/userinfo?access_token=</span><span style=\"color: #C678DD\">${</span><span style=\"color: #E5C07B\">params</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">access_token</span><span style=\"color: #C678DD\">}</span><span style=\"color: #98C379\">&amp;openid=</span><span style=\"color: #C678DD\">${</span><span style=\"color: #E5C07B\">params</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">openid</span><span style=\"color: #C678DD\">}</span><span style=\"color: #98C379\">&amp;lang=`</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #E06C75\">method</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #98C379\">&#39;get&#39;</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  })</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>最后来编写service层</p>\n<pre class=\"pre-dark\"><code><span class=\"line\"><span style=\"color: #E06C75\">async</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">wxGetAuthorizationUserInfo</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">code</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #E06C75\">string</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">|</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E06C75\">number</span><span style=\"color: #ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">   </span><span style=\"color: #C678DD\">try</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">     </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">res</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #E5C07B\">IwxAccessToken</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">await</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">getAccessTokenApi</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">code</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">     </span><span style=\"color: #C678DD\">if</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E5C07B\">res</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">access_token</span><span style=\"color: #ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">       </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">info</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #E5C07B\">IwxGotItUserInfo</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">await</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">getUserInfoApi</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">res</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">       </span><span style=\"color: #C678DD\">if</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E5C07B\">info</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">openid</span><span style=\"color: #ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">         </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">log</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">&#39;这是用户信息&#39;</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">info</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">         </span><span style=\"color: #C678DD\">return</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E06C75\">info</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">       }</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">     }</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">   } </span><span style=\"color: #C678DD\">catch</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">error</span><span style=\"color: #ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">     </span><span style=\"color: #C678DD\">throw</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">new</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">errResult</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #D19A66\">500</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">error</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">   }</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\"> }</span></span>\n<span class=\"line\"></span></code></pre>\n"}}]]}]
